generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  birthDate String?
  phone     String?
  gender    String?
   
  // Controle de Acesso e Planos
  plan_tier String   @default("standard")
  role      String   @default("USER") // ADMIN ou USER
  plan      String   @default("PERFORMANCE") // FREE, ELITE, VIP
  active    Boolean  @default(true)
   
  // Dados R√°pidos (Cache)
  currentWeight Float? // Peso atualizado pelo check-in ou avalia√ß√£o
   
  // Gamification & Notifica√ß√µes
  currentXP Int      @default(0)
  pushToken String?  // Para notifica√ß√µes OneSignal/Expo
   
  createdAt DateTime @default(now())

  // Relacionamentos
  workouts    Workout[]
  anamneses   Anamnese[]
  history     WorkoutHistory[] 
  assessments Assessment[]       
  checkIns    CheckIn[]
  
  // PA FLIX & Comunidade
  contentLikes    ContentLike[]
  contentComments ContentComment[]
  contentCompletions ContentCompletion[] // üî• NOVO: Hist√≥rico de aulas assistidas
}

model Exercise {
  id            String   @id @default(uuid())
  name          String   @unique
  category      String
  videoUrl      String?
  instructions String?
  createdAt     DateTime @default(now())
   
  // Relacionamentos
  workoutExercises WorkoutExercise[] 
  asSubstitute     WorkoutExercise[] @relation("SubstituteRelation")
}

model Workout {
  id        String    @id @default(uuid())
  name      String    
  goal      String?   
  level     String?   
  isVisible Boolean   @default(true)
   
  // Planejamento
  startDate DateTime? @default(now()) 
  endDate   DateTime? 
  archived  Boolean   @default(false) 
   
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  exercises WorkoutExercise[]
  createdAt DateTime  @default(now())
}

model WorkoutExercise {
  id        String   @id @default(uuid())
  workoutId String
  workout   Workout  @relation(fields: [workoutId], references: [id], onDelete: Cascade)
   
  // Exerc√≠cio Principal
  exerciseId String
  exercise   Exercise @relation(fields: [exerciseId], references: [id])
   
  // Exerc√≠cio Substituto (Opcional)
  substituteId String?
  substitute   Exercise? @relation("SubstituteRelation", fields: [substituteId], references: [id])

  restTime  Int      @default(60)
  title     String?  
  sets      Int      @default(3)
  reps      String   @default("12") 
  notes     String?  
  technique String?  
  day       String   @default("A") 
  order     Int      @default(0) 
}

model Anamnese {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
   
  // Dados F√≠sicos
  peso            Float
  altura          Float
  imc             Float?    
  aguaIdeal       Float?    
   
  // Objetivos
  objetivo        String    
  nivel           String    
   
  // Rotina
  frequencia      Int       
  tempoDisponivel Int      @default(60) 
   
  // Sa√∫de (Arrays)
  limitacoes      String[] 
  cirurgias       String[] 
  equipamentos    String[] 
   
  createdAt       DateTime @default(now())
}

model WorkoutTemplate {
  id        String   @id @default(uuid())
  name      String    
  goal      String    
  level     String    
  data      String    @db.Text 
  createdAt DateTime @default(now())
}

// Hist√≥rico de Treinos (Gamification)
model WorkoutHistory {
  id             String   @id @default(uuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
   
  name           String    
  workoutName  String? 
  date           DateTime @default(now())
  xpEarned       Int      @default(0)
  duration       Int?      
  progressions Int      @default(0) 

  rpe            Int?      
  feedback       String?  

  details        ExerciseHistory[]
}

model ExerciseHistory {
  id               String         @id @default(uuid())
  workoutHistoryId String
  workoutHistory   WorkoutHistory @relation(fields: [workoutHistoryId], references: [id], onDelete: Cascade)
   
  exerciseId       String
  exerciseName     String
   
  setNumber        Int
  weight           Float  
  reps             String 
}

// Avalia√ß√£o F√≠sica (Pollock/Dobras)
model Assessment {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date            DateTime @default(now())
   
  // N√≠vel 1: B√°sico
  weight          Float    
  height          Float?    
  photos          String[] 
   
  // N√≠vel 2: Medidas (cm)
  neck            Float?    
  shoulders       Float?    
  chest           Float?    
  arms            Float?    
  forearms        Float?    
  waist           Float?    
  abdomen         Float?    
  hips            Float?    
  thighs          Float?    
  calves          Float?    
   
  // N√≠vel 3: Composi√ß√£o (mm)
  method          String?  // "POLLOCK_7", "BIO", "MANUAL"
   
  foldTriceps     Float?
  foldSubscapular Float?
  foldChest       Float?
  foldAxillary    Float?
  foldSuprailiac  Float?
  foldAbdominal   Float?
  foldThigh       Float?
   
  // Resultados
  bodyFat         Float?    
  visceralFat     Float?    
  muscleMass      Float?    
   
  notes           String?   
  createdAt       DateTime @default(now())
}

// Check-in Di√°rio/Semanal
model CheckIn {
  id            String   @id @default(uuid())
  date          DateTime @default(now())
   
  weight        Float?
  feedback      String?  
   
  photoFront    String? 
  photoBack     String?
  photoSide     String?
   
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now())
}

// Mural de Avisos do Admin
model Notice {
  id        String   @id @default(uuid())
  title     String
  content   String   @db.Text
  active    Boolean  @default(true)
  date      DateTime @default(now())
}

// üî• PA FLIX (√Årea de Conte√∫do e Comunidade)
model Content {
  id          String   @id @default(uuid())
  title       String
  subtitle    String?
  description String?  @db.Text
   
  category    String   // Ex: 'TECNICA', 'MINDSET', 'NUTRICAO'
   
  videoUrl    String   // Link do v√≠deo (Cloudflare/YouTube)
  thumbUrl    String?  // Capa do v√≠deo
  duration    String?  // Ex: "12 min"
   
  createdAt   DateTime @default(now())
   
  // Rela√ß√µes Sociais
  likes       ContentLike[]
  comments    ContentComment[]
  completions ContentCompletion[] // üî• NOVO: Rela√ß√£o com quem assistiu
}

model ContentLike {
  id        String   @id @default(uuid())
   
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
   
  contentId String
  content   Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)
   
  createdAt DateTime @default(now())

  @@unique([userId, contentId])
}

model ContentComment {
  id        String   @id @default(uuid())
  text      String   @db.Text
   
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
   
  contentId String
  content   Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)
   
  createdAt DateTime @default(now())
}

// üî• NOVO MODELO: Controle de XP por v√≠deo assistido
model ContentCompletion {
  id        String   @id @default(uuid())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  contentId String
  content   Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())

  @@unique([userId, contentId]) // Garante que o usu√°rio s√≥ ganhe XP 1x por v√≠deo
}